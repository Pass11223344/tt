# åˆ†å‘å™¨

## å¼‚æ­¥è¯·æ±‚æµç¨‹

``` puml
skinparam ActivityBackgroundColor #eeeeee
skinparam backgroundColor #lightgrey 
skinparam shadowing false
|RealCall|
:enqueue;
|Dispacther|
:enqueue(AsyncCall);
|readyAsyncCalls|
:add(AsyncCall);
|Dispacther|
:promoteAndExecute;
|readyAsyncCalls|
:éå†;
while (runningAsyncCallså®¹é‡<64) is (Yes)
if(åŒåŸŸåè¯·æ±‚æ•°<=5) then (Yes)
|runningAsyncCalls|
:æ·»åŠ ;
else (No)
endif
endwhile (No)
|readyAsyncCalls|
:éå†ç»“æŸ;
|runningAsyncCalls|
:éå†;
|ExecutorService|
:executeæ‰§è¡Œä»»åŠ¡;
|Dispacther|
:finish;
:promoteAndExecute;
```

1. é¦–å…ˆè°ƒç”¨newCall()ï¼Œè·å¾—RealCallå¯¹è±¡ã€‚
``` java
// OkHttpClient.java
@Override 
public Call newCall(Request request) {
    return RealCall.newRealCall(this, request, false /* for web socket */);
}
```

2. æ‰§è¡ŒCall.enqueue()å‘èµ·å¼‚æ­¥è¯·æ±‚ã€‚
``` java
@Override 
public void enqueue(Callback responseCallback) {
    // é™åˆ¶è¿ç»­å‘èµ·è¯·æ±‚
    synchronized (this) {
      if (executed) throw new IllegalStateException("Already Executed");
      executed = true;
    }
    
    // åˆ†å‘å™¨(dispatcher)æŠŠä»»åŠ¡(AsyncCall)æ”¾åˆ°æ‰§è¡Œé˜Ÿåˆ—(runningAsycCalls)
    // æˆ–ç­‰å¾…é˜Ÿåˆ—(readyAsyncCalls)ä¸­ï¼Œç”±çº¿ç¨‹æ± æ¥å¤„ç†ã€‚
    //
    // å…³é”®ï¼šè·å–åˆ†å‘å™¨ï¼Œè°ƒç”¨å®ƒçš„queueæ–¹æ³•
    client.dispatcher().enqueue(new AsyncCall(responseCallback));
}
```
ğŸ¤”ï¼šåˆ†å‘å™¨çš„enqueue()å†…éƒ¨æ˜¯æ€ä¹ˆæ“ä½œçš„ï¼Ÿ[ä¸€æ¢ç©¶ç«Ÿ](doc/DispatchEnqueue.md)ã€‚