# Java虚拟机栈

## 概述

JVM的栈区是用于存储线程执行时的方法调用和局部变量的内存区域，具有后进先出的特点。

每个线程都有独立的栈区，用于保存方法调用的执行环境和局部变量。

栈区的大小是固定的，通过栈帧来管理方法调用和参数传递。

当方法调用结束或线程结束时，栈帧会被弹出，释放相关内存。栈区的操作速度快，但容量有限，不适合存储大量对象。

## 详述

Java虚拟机（JVM）的栈区（Stack）是用于存储方法执行的内存模型，其存储的主要内容是线程执行方法的栈帧（Stack Frame）。每个方法被调用至其完成的过程对应着一个栈帧在栈区的入栈和出栈过程。

### JVM的栈区特性

1. **线程隔离**：JVM的栈区是线程私有的，每个线程有自己独立的栈区，与其他线程的栈区隔离。

2. **方法执行的内存模型**：每个方法被调用时，JVM都会生成一个新的栈帧，并将其压入栈中。该方法的局部变量、操作数栈等都存储在这个栈帧中。

3. **内存分配与回收效率高**：栈区的内存分配和回收由CPU自动管理，当方法结束时，其所占用的栈帧随即被弹出，内存自动释放，效率很高。

### 栈帧（Stack Frame）的组成部分

- **局部变量表（Local Variables）**：存储方法内的局部变量。局部变量表所需的内存空间在编译期间就已确定，并在方法运行期间分配。

- **操作数栈（Operand Stack）**：也被称为表达式栈，用于存储临时变量。

- **动态链接（Dynamic Linking）**：指向运行时常量池的方法引用，支持方法调用过程中的动态链接。

- **方法返回地址**：用于存储从哪个指令继续执行的地址。

- **附加信息**：一些附加的用于支持方法调用、异常处理等其他操作的信息。

### 栈区的工作流程

- **方法调用**：每当线程调用一个方法时，JVM都会压入一个新的栈帧到该线程的栈区。

- **方法执行**：方法执行的过程对应着栈帧在操作数栈中的操作过程，包括局部变量的读写、指令的执行等。

- **方法返回**：方法返回的过程对应着栈帧的出栈操作。方法返回后，这部分内存会被立即释放。

### 栈区的相关问题

- **栈溢出**：如果线程请求的栈深度大于虚拟机所允许的最大深度，将抛出`StackOverflowError`异常。

- **栈内存不足**：如果虚拟机栈可以动态扩展，并且在尝试扩展时无法申请到足够的内存，或者在创建新线程时没有足够的内存进行Java虚拟机栈的初始化，那么Java虚拟机将抛出`OutOfMemoryError`异常。

### JVM参数配置

- **设置栈的大小**：`-Xss<size>`，例如 `-Xss1m`。这会影响到线程能够调用的方法的最大深度。

理解JVM的栈区及其工作原理，对于分析和优化程序的性能、分析线程执行的状态和数据、诊断线程执行时的问题等方面是很有帮助的。

## 问题补充

### 垃圾回收是否涉及栈区？

不会。因为每次方法调用结束后，栈帧会自动弹出栈，所占内存会被释放掉。

### 栈内存分配越大越好吗？

不是。栈内存分配过大，会导致线程数减少。物理内存是固定的，栈内存变大后，可执行的线程数会减少。

### 方法内的局部变量是否是线程安全的？
如果局部变量没有作为返回值返回，或是传承传入，那么是线程安全的。
> 因为局部变量位于java虚拟机栈的栈帧中，java虚拟机栈会为每个线程创建一个单独的栈，所以栈帧中的数据是线程安全的。

如果局部变量接收了方法传参，或是作为返回值返回，有可能被其它线程访问和修改，不一定安全。