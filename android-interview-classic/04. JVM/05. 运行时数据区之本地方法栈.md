# Native方法栈

## 概述

JVM的本地方法栈是用于执行本地方法（Native Method）的内存区域，与栈区类似。

本地方法栈用于存储本地方法的调用和执行环境，并提供给本地方法使用的内存空间。

与Java方法调用不同，本地方法是用其他语言（如C或C++）编写的方法，通过本地方法接口与Java程序进行交互。

本地方法栈的大小和操作方式与栈区类似，都是通过栈帧来管理方法调用和参数传递。

## 详述

Java虚拟机（JVM）中的本地方法栈（Native Method Stack）是为Native方法（即用非Java语言实现的方法，通常是C或C++）服务的。在Java应用中，我们可以通过Java Native Interface (JNI) 调用这些Native方法。

### 本地方法栈的主要作用：

1. **存储Native方法的状态**：当线程调用一个Native方法时，JVM会在本地方法栈中创建一个栈帧，用于存储该Native方法的状态，包括参数、局部变量、返回值等信息。
   
2. **支持Native方法的调用**：通过存储Native方法的状态，使得Java程序可以调用Native方法，并在Native方法完成后，正确返回到Java方法中。

### 本地方法栈和Java虚拟机栈的区别：

- **Java虚拟机栈**：是为Java方法（即字节码）服务的。每个Java方法在执行的同时会创建一个Java栈帧，用于存储局部变量、操作数栈、常量池引用等信息。
   
- **本地方法栈**：是为Native方法服务的。虽然Java方法和Native方法在表现上类似，但在实现上它们存在很大的差异。本地方法在执行时，会依赖于本地方法接口（JNI）和本地方法栈。

### 与本地方法栈相关的问题：

- **栈溢出**：如果线程请求的栈深度大于虚拟机所允许的深度，将抛出`StackOverflowError`异常。

- **栈内存不足**：如果虚拟机栈可以动态扩展，并且在尝试扩展时无法申请到足够的内存，或者在创建新线程时没有足够的内存进行虚拟机栈的初始化，那么Java虚拟机将抛出`OutOfMemoryError`异常。

### JVM参数配置与本地方法栈：

- **设置本地方法栈的大小**：通过JVM启动参数 `-Xss` 可以设置线程的栈大小，这个设置同时影响到Java虚拟机栈和本地方法栈的大小。

### 注意点：

- 对于支持Java SE HotSpot虚拟机来说，Java虚拟机栈和本地方法栈是合并在一起的，因此通过`-Xss`参数设置的栈大小是这两部分的总和。

本地方法栈主要与Java中的Native方法的使用相关，通常来说，在一些对性能要求非常高的场合，或是为了调用一些底层的、特定的硬件接口，我们会使用到Native方法。理解本地方法栈有助于我们更好地理解和使用Native方法，以及诊断与Native方法相关的问题。