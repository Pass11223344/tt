# 方法区和元空间

## 概述

JVM的方法区和元空间都是用于**存储类的元数据和常量池等信息**的内存区域。
### 区别一
1. 方法区是传统的JVM内存模型中的一部分。
2. 元空间是在**JDK 8**及以后版本中引入的替代方案。
### 区别二
1. 方法区是位于JVM堆区之外的一块内存。
2. 元空间则是使用本机内存（即**物理内存**）来存储类的元数据。
### 区别三
1. 方法区的大小是固定的。
2. 元空间则可以根据需要**动态分配和释放内存**。

元空间的引入主要是为了**解决方法区在大量类加载时可能导致内存溢出的问题**，并提供更灵活的内存管理机制。

## 详述

在Java虚拟机（JVM）的体系结构中，**方法区**和**元空间**（Metaspace）都扮演着非常重要的角色。它们用于存储JVM加载的类信息、常量、静态变量、即时编译后的代码等数据。

### 方法区（Method Area）

- **定义与功能**：方法区是堆的一个逻辑部分，它用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。
  
- **特性**：
  - **线程共享区域**：所有的线程共享方法区中的内容。
  - **内存回收目标**：虽然Java堆是垃圾收集的主要区域，但方法区亦然（例如常量池的回收、类型的卸载）。
  - **异常**：如果方法区无法满足内存分配需求时，将抛出`OutOfMemoryError`异常。
  
- **组成部分**：
  - **运行时常量池**：用于存放编译期生成的各种字面量和符号引用，这部分内容将在类加载后进入方法区的运行时常量池存储。
  - **字段信息**：包括字段的名称、数据类型、访问控制修饰符等。
  - **方法信息**：包括方法的名称、返回类型、参数类型、访问控制修饰符等。
  - **类信息**：包括类的名称、访问控制修饰符、父类、实现的接口等。

### 元空间（Metaspace）

- **引入背景**：从Java 8开始，元空间取代了方法区中的**永久代**（PermGen space）。永久代使用的是JVM的堆内存，而元空间使用的是本机内存（即非堆内存）。

- **特性**：
  - **使用本机内存**：元空间使用的是本机内存，不再受Java堆大小的限制，能够动态地增加大小（取决于系统可用内存）。
  - **自动调整大小**：元空间会根据应用的需求自动调整大小，不过也可以使用JVM参数进行限制。
  - **更好的性能**：元空间的引入旨在提供更加稳定的性能表现，尤其是对于那些需要加载和卸载大量类的应用。

- **JVM参数**：
  - **`-XX:MetaspaceSize`**：设置元空间初始大小。
  - **`-XX:MaxMetaspaceSize`**：设置元空间最大大小。如果不设置此参数，元空间会动态调整大小，受系统可用内存限制。
  
- **内存溢出**：如果元空间无法分配内存，将抛出`OutOfMemoryError`异常。

### 方法区与元空间的关系

简而言之，在Java 8及之前的版本（包括Java 7、Java 6等），方法区通常实现为永久代。在Java 8及之后的版本，方法区的一部分实现被称为元空间，它使用本机内存而不是堆内存。

理解方法区和元空间的工作机制能够更好地进行JVM性能调优，避免内存泄漏和内存溢出，同时也有助于在遇到与类加载相关的问题时进行问题定位和问题解决。