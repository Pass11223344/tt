# Java内存模型

## 概述

JMM（Java内存模型）定义了多线程程序中线程如何与内存交互。确保可见性、有序性和原子性操作，提供线程安全的内存访问方式。

## 详述

**Java Memory Model（JMM）** 是 Java 虚拟机（JVM）的一部分，它描述了 Java 程序中各个线程如何和主内存以及彼此之间交互的规则。JMM 定义了线程和主内存之间的抽象关系：线程之间的共享变量存储在主内存中，每个线程都有一个私有的本地内存，本地内存中存储了该线程以读/写共享变量的副本。

下面简要说明一下 JMM 的几个核心概念和规则：

### 1. 内存模型的主要元素

- **共享变量**：从语义上讲，JMM 所关心的是一个线程写入一个变量（通过共享变量实现通讯）是否对另一个线程可见。
  
- **主内存与工作内存**：
  - **主内存**：保存共享变量的内存，所有线程都能访问。
  - **工作内存**：每个线程私有的内存区域，保存了被该线程使用到的共享变量的副本。
  
### 2. 内存间的交互操作

JMM 定义了8种操作来完成主内存和工作内存之间的交互操作，这8种操作包括：lock、unlock、read、load、use、assign、store、write。

### 3. JMM的核心规则

- **线程解锁前，必须把共享变量的最新值刷新到主内存中**。
  
- **线程加锁时，将清空工作内存中共享变量的值，从而使用共享变量时需要从主内存中重新读取**（加锁和解锁需要同一个锁）。

- **线程解锁前，必须在工作内存中执行完毕assign操作，即重新赋值引用类型变量**。

### 4. 内存模型的目标

- **原子性**：提供一种读-修改-写（read-modify-write）的原子操作指令。
  
- **可见性**：一线程对共享变量值的修改，能够及时地被其他线程看到。
  
- **有序性**：程序执行的顺序按照代码的先后顺序执行。
  
### 5. Happens-Before 规则

"**Happens-Before**" 是用来指定两个操作之间的执行顺序的。如果操作 A Happens-Before 操作 B，那么 A 的执行结果将对 B 可见，且 A 的执行顺序排在 B 之前。几个基本的Happens-Before规则如下：

- **程序的顺序性规则**：一个线程内按照代码顺序，书写在前面的操作 Happens-Before 书写在后面的操作。
  
- **监视器锁规则**：一个 unlock 操作 Happens-Before 后面对同一个锁的 lock 操作。
  
- **线程的start()规则**：线程的 start() 方法 Happens-Before 该线程中的任何其他操作。
  
- **线程的终止规则**：线程中的所有操作都 Happens-Before 其它线程检测到这个线程已经结束，检测方法包括：Thread.join()方法、Thread.isAlive()方法返回false。

- **线程中断规则**：对线程的 interrupt() 方法的调用 Happens-Before 发生于被中断线程代码检测到中断事件的地方。

- **对象的 finalize() 规则**：对象的构造函数执行结束 Happens-Before 它的 finalize() 方法的开始。

### 总结

JMM 通过控制指令的重排和保证"主内存"和"工作内存"之间数据传输的可见性，为我们提供了在多线程环境中共享变量访问的一致性和安全性。理解JMM，尤其是 Happens-Before 规则对于编写正确和高效的并发程序至关重要。